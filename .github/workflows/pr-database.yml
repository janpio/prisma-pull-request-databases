name: Database for PR
on:
  push:

jobs:
  migrate-db:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1

      - uses: jwalton/gh-find-current-pr@v1
        id: findPr

      - run: echo "Your PR is ${PR}"
        if: success() && steps.findPr.outputs.number
        env:
          PR: ${{ steps.findPr.outputs.pr }}

      - name: manipulate DATABASE_URL
        id: manipulateUrl
        run: |
          echo ::set-output name=url::"${DATABASE_URL/defaultdb/${{ steps.findPr.outputs.pr }}}"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          
      - run: echo $DATABASE_URL
        env:
          DATABASE_URL: ${{ steps.manipulateUrl.outputs.url }}

      - run: npx prisma db push --preview-feature
        env:
          DATABASE_URL: ${{ steps.manipulateUrl.outputs.url }}

      - run: npx prisma studio &
        env:
          DATABASE_URL: ${{ steps.manipulateUrl.outputs.url }}
          
      - uses: apogiatzis/ngrok-tunneling-action@v0.1.4
        with:
          timeout: 1h
          port: 5555
          ngrok_authtoken: ${{ secrets.NGROK_AUTHTOKEN }}